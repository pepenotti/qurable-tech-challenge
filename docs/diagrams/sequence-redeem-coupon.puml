@startuml Redeem Coupon
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

title Redeem Coupon - Permanent Operation (High-Level)

actor User
participant "API" as API
database "Database" as DB

User -> API : POST /coupons/redeem/{code}\n{user_id, metadata}
activate API

API -> DB : BEGIN TRANSACTION
activate DB

API -> DB : SELECT coupon + book config\n**FOR UPDATE**

DB --> API : Coupon + Settings

API -> API : Validate:\n- User owns coupon?\n- Not expired?\n- Under redemption limit?

alt Validation Failed
    API -> DB : ROLLBACK
    API --> User : 400/403 Error
else Validation Passed
    API -> DB : UPDATE coupon\nSET state='REDEEMED'\nINC redemption_count
    
    API -> DB : INSERT redemption_history\n(audit trail)
    
    API -> DB : COMMIT
    deactivate DB
    
    API --> User : 200 OK\n{success: true, history_id: ...}
end
deactivate API

note over User, DB
  **Key Points for Interview:**
  1. **Permanent operation** (no undo)
  2. **Atomic transaction** (update + audit)
  3. **Multi-redemption support** (configurable)
  4. **Audit trail** for compliance
  5. Either ALL succeed or ALL fail
end note

@enduml
