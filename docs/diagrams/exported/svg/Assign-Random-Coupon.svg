<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="707px" preserveAspectRatio="none" style="width:795px;height:707px;background:#FEFEFE;" version="1.1" viewBox="0 0 795 707" width="795px" zoomAndPan="magnify"><title>Assign Random Coupon to User (High-Level)</title><defs/><g><rect fill="#FEFEFE" height="707" style="stroke:none;stroke-width:1;" width="795" x="0" y="0"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="324.6318" x="234.2336" y="28.5352">Assign Random Coupon to User (High-Level)</text><g><title>API</title><rect fill="#FFFFFF" height="346.6582" style="stroke:#181818;stroke-width:1;" width="10" x="278.1846" y="165.5977"/></g><g><title>Database</title><rect fill="#FFFFFF" height="272.7266" style="stroke:#181818;stroke-width:1;" width="10" x="546.6924" y="194.9082"/></g><g><title>User</title><rect fill="#000000" fill-opacity="0.00000" height="507.832" width="8" x="24.1826" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="28" x2="28" y1="118.9766" y2="626.8086"/></g><g><title>API</title><rect fill="#000000" fill-opacity="0.00000" height="507.832" width="8" x="279.1846" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="282.4692" x2="282.4692" y1="118.9766" y2="626.8086"/></g><g><title>Database</title><rect fill="#000000" fill-opacity="0.00000" height="507.832" width="8" x="547.6924" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="551.3599" x2="551.3599" y1="118.9766" y2="626.8086"/></g><g class="participant participant-head" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.3652" x="10" y="116.0234">User</text><ellipse cx="28.1826" cy="50.9883" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M28.1826,58.9883 L28.1826,85.9883 M15.1826,66.9883 L41.1826,66.9883 M28.1826,85.9883 L15.1826,100.9883 M28.1826,85.9883 L41.1826,100.9883" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.3652" x="10" y="639.3438">User</text><ellipse cx="28.1826" cy="650.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M28.1826,658.7969 L28.1826,685.7969 M15.1826,666.7969 L41.1826,666.7969 M28.1826,685.7969 L15.1826,700.7969 M28.1826,685.7969 L41.1826,700.7969" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="API"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="35.4307" x="265.4692" y="87.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.4307" x="272.4692" y="108.0234">API</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="35.4307" x="265.4692" y="625.8086"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.4307" x="272.4692" y="646.3438">API</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62.665" x="517.3599" y="116.0234">Database</text><path d="M533.6924,66.4883 C533.6924,56.4883 551.6924,56.4883 551.6924,56.4883 C551.6924,56.4883 569.6924,56.4883 569.6924,66.4883 L569.6924,92.4883 C569.6924,102.4883 551.6924,102.4883 551.6924,102.4883 C551.6924,102.4883 533.6924,102.4883 533.6924,92.4883 L533.6924,66.4883" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M533.6924,66.4883 C533.6924,76.4883 551.6924,76.4883 551.6924,76.4883 C551.6924,76.4883 569.6924,76.4883 569.6924,66.4883" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62.665" x="517.3599" y="639.3438">Database</text><path d="M533.6924,652.2969 C533.6924,642.2969 551.6924,642.2969 551.6924,642.2969 C551.6924,642.2969 569.6924,642.2969 569.6924,652.2969 L569.6924,678.2969 C569.6924,688.2969 551.6924,688.2969 551.6924,688.2969 C551.6924,688.2969 533.6924,688.2969 533.6924,678.2969 L533.6924,652.2969" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M533.6924,652.2969 C533.6924,662.2969 551.6924,662.2969 551.6924,662.2969 C551.6924,662.2969 569.6924,662.2969 569.6924,652.2969" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g><title>API</title><rect fill="#FFFFFF" height="346.6582" style="stroke:#181818;stroke-width:1;" width="10" x="278.1846" y="165.5977"/></g><g><title>Database</title><rect fill="#FFFFFF" height="272.7266" style="stroke:#181818;stroke-width:1;" width="10" x="546.6924" y="194.9082"/></g><g class="message" data-participant-1="User" data-participant-2="API"><polygon fill="#181818" points="266.1846,161.5977,276.1846,165.5977,266.1846,169.5977,270.1846,165.5977" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="28.1826" x2="272.1846" y1="165.5977" y2="165.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144.1934" x="81.0869" y="145.5449">POST /coupons/assign</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112.5693" x="96.8989" y="160.8555">{book_id, user_id}</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="534.6924,190.9082,544.6924,194.9082,534.6924,198.9082,538.6924,194.9082" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="288.1846" x2="540.6924" y1="194.9082" y2="194.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133.0278" x="350.9246" y="190.166">BEGIN TRANSACTION</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="534.6924,253.8398,544.6924,257.8398,534.6924,261.8398,538.6924,257.8398" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="288.1846" x2="540.6924" y1="257.8398" y2="257.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234.5078" x="300.1846" y="237.7871">SELECT random UNASSIGNED coupon</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="178.001" x="328.438" y="253.0977">FOR UPDATE SKIP LOCKED</text></g><path d="M561,207.9082 L561,278.9082 L788,278.9082 L788,217.9082 L778,207.9082 L561,207.9082" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M778,207.9082 L778,217.9082 L788,217.9082 L778,207.9082" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="130.6919" x="567" y="225.4766">Concurrency Magic:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.6582" x="567" y="240.7871">- FOR UPDATE = Lock the row</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206.4067" x="567" y="256.0977">- SKIP LOCKED = Skip busy rows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139.3945" x="567" y="271.4082">&#8594; No race conditions!</text><g class="message" data-participant-1="DB" data-participant-2="API"><polygon fill="#181818" points="299.1846,301.4609,289.1846,305.4609,299.1846,309.4609,295.1846,305.4609" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="293.1846" x2="545.6924" y1="305.4609" y2="305.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103.2764" x="365.8003" y="300.7188">Coupon (locked)</text></g><g class="message" data-participant-1="API" data-participant-2="API"><line style="stroke:#181818;stroke-width:1;" x1="288.1846" x2="330.1846" y1="365.3926" y2="365.3926"/><line style="stroke:#181818;stroke-width:1;" x1="330.1846" x2="330.1846" y1="365.3926" y2="378.3926"/><line style="stroke:#181818;stroke-width:1;" x1="289.1846" x2="330.1846" y1="378.3926" y2="378.3926"/><polygon fill="#181818" points="299.1846,374.3926,289.1846,378.3926,299.1846,382.3926,295.1846,378.3926" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="54.7739" x="366.126" y="330.0293">Validate:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81.0342" x="352.9958" y="345.3398">- User exists</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196.6567" x="295.1846" y="360.6504">- Under max assignments limit</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="534.6924,434.3242,544.6924,438.3242,534.6924,442.3242,538.6924,438.3242" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="288.1846" x2="540.6924" y1="438.3242" y2="438.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101.2261" x="366.8254" y="402.9609">UPDATE coupon</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135.9414" x="349.4678" y="418.2715">SET state='ASSIGNED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.3979" x="322.2395" y="433.582">SET assigned_user_id=user_id</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="539.6924,463.6348,549.6924,467.6348,539.6924,471.6348,543.6924,467.6348" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="288.1846" x2="545.6924" y1="467.6348" y2="467.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53.4536" x="393.2117" y="462.8926">COMMIT</text></g><g class="message" data-participant-1="API" data-participant-2="User"><polygon fill="#181818" points="39.1826,508.2559,29.1826,512.2559,39.1826,516.2559,35.1826,512.2559" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="33.1826" x2="282.1846" y1="512.2559" y2="512.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47.3599" x="132.0037" y="492.2031">200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226.002" x="42.6826" y="507.5137">{code: "ABC123", state: "ASSIGNED"}</text></g><path d="M5,525.2559 L5,611.2559 L576,611.2559 L576,535.2559 L566,525.2559 L5,525.2559" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M566,525.2559 L566,535.2559 L576,535.2559 L566,525.2559" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="164.1694" x="138.6643" y="542.8242">Key Points for Interview:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="253.9697" x="138.6643" y="558.1348">1. Random selection from available pool</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="294.6963" x="138.6643" y="573.4453">2. Pessimistic locking prevents race conditions</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="233.2065" x="138.6643" y="588.7559">3. Atomic transaction (all or nothing)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229.5376" x="138.6643" y="604.0664">4. Fast even under high concurrency</text><!--SRC=[PLDDZzem4BtxLqpfOG41kylsX4Iba8HjnAT8w0bfPPBPO15i6Zliecgl_G7zYVqb7IV0igroSEnvVZFpvbblXTppdEzWpUDjcgj29gxAL0wVXxxzcBuWDFueKCOuGQrvYaucKWanIeCvOqQO3C7HsXukk4pK3bnLx9K4es2fCOVwDv5kscCyODPWZCU6ijW08teZOh7dqa3DcGSru1fePGatVCqrGiqx_PKXRy1OoTZ-Qc7GW_aiZE0sBlFfMrvMiP8_rqfjdqJIWeBGzFDciue3DrZICtkPEBm1KGpyns0AqSAPXeuR1RFfEzRckuQ6_jXt8yYhBfTJ9mo3nwdlGLN0IZQRmza2bdFFYNm8Hy4SnZDtv7lD9fEA27CImZ20PjDLCYxod6GzmeId8kuH1g0DLmHz6Aju2sP35zLB6RtYf72u5NjO5_feuve0VtxzXgcY0cEaccGYZ21TFZ6K2TW26AC-sXVrJdEgPvG6ayQbsIhwdMU21e6zbMnNWyHNeOqkjpAX_Ow_GgNvZjoW8HCxOJvATchbB53eHw0DaVPlpkBTLASL3oPFfv7rJ-j7EdSscGGHI_3_6H6aBB87tRixc8t81h5Ai4VE6hZttOTQgyfi3qwfQs_NJAKpoZ6f0rOERLbwEwuH7c6kX6tocTmRMEyV1BvKKxlld9slCSFOYWxFEMtvWOkCh-c1x9NA2Ddjm9nU4UcaoVbWXHSoXNrEZyEI_pCvkl7G0SUe7O4D-KxpYhtEimoe42ftGmGD0dxfm91h0vO9Yd8-6xARPJixxTq7Vm40]--></g></svg>