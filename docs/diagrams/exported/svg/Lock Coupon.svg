<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="806px" preserveAspectRatio="none" style="width:661px;height:806px;background:#FEFEFE;" version="1.1" viewBox="0 0 661 806" width="661px" zoomAndPan="magnify"><title>Lock Coupon for Redemption (High-Level)</title><defs/><g><rect fill="#FEFEFE" height="806" style="stroke:none;stroke-width:1;" width="661" x="0" y="0"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="305.6689" x="176.6755" y="28.5352">Lock Coupon for Redemption (High-Level)</text><g><title>API</title><rect fill="#FFFFFF" height="438.2344" style="stroke:#181818;stroke-width:1;" width="10" x="264.3237" y="165.5977"/></g><g><title>Database</title><rect fill="#FFFFFF" height="349.3027" style="stroke:#181818;stroke-width:1;" width="10" x="514.2202" y="194.9082"/></g><rect fill="none" height="224.75" style="stroke:#000000;stroke-width:1.5;" width="553.5527" x="10" y="372.082"/><g><title>User</title><rect fill="#000000" fill-opacity="0.00000" height="606.7188" width="8" x="34.1826" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="38" x2="38" y1="118.9766" y2="725.6953"/></g><g><title>API</title><rect fill="#000000" fill-opacity="0.00000" height="606.7188" width="8" x="265.3237" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="268.6084" x2="268.6084" y1="118.9766" y2="725.6953"/></g><g><title>Database</title><rect fill="#000000" fill-opacity="0.00000" height="606.7188" width="8" x="515.2202" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="518.8877" x2="518.8877" y1="118.9766" y2="725.6953"/></g><g class="participant participant-head" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.3652" x="20" y="116.0234">User</text><ellipse cx="38.1826" cy="50.9883" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M38.1826,58.9883 L38.1826,85.9883 M25.1826,66.9883 L51.1826,66.9883 M38.1826,85.9883 L25.1826,100.9883 M38.1826,85.9883 L51.1826,100.9883" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.3652" x="20" y="738.2305">User</text><ellipse cx="38.1826" cy="749.6836" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M38.1826,757.6836 L38.1826,784.6836 M25.1826,765.6836 L51.1826,765.6836 M38.1826,784.6836 L25.1826,799.6836 M38.1826,784.6836 L51.1826,799.6836" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="API"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="35.4307" x="251.6084" y="87.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.4307" x="258.6084" y="108.0234">API</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="35.4307" x="251.6084" y="724.6953"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.4307" x="258.6084" y="745.2305">API</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62.665" x="484.8877" y="116.0234">Database</text><path d="M501.2202,66.4883 C501.2202,56.4883 519.2202,56.4883 519.2202,56.4883 C519.2202,56.4883 537.2202,56.4883 537.2202,66.4883 L537.2202,92.4883 C537.2202,102.4883 519.2202,102.4883 519.2202,102.4883 C519.2202,102.4883 501.2202,102.4883 501.2202,92.4883 L501.2202,66.4883" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M501.2202,66.4883 C501.2202,76.4883 519.2202,76.4883 519.2202,76.4883 C519.2202,76.4883 537.2202,76.4883 537.2202,66.4883" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62.665" x="484.8877" y="738.2305">Database</text><path d="M501.2202,751.1836 C501.2202,741.1836 519.2202,741.1836 519.2202,741.1836 C519.2202,741.1836 537.2202,741.1836 537.2202,751.1836 L537.2202,777.1836 C537.2202,787.1836 519.2202,787.1836 519.2202,787.1836 C519.2202,787.1836 501.2202,787.1836 501.2202,777.1836 L501.2202,751.1836" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M501.2202,751.1836 C501.2202,761.1836 519.2202,761.1836 519.2202,761.1836 C519.2202,761.1836 537.2202,761.1836 537.2202,751.1836" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g><title>API</title><rect fill="#FFFFFF" height="438.2344" style="stroke:#181818;stroke-width:1;" width="10" x="264.3237" y="165.5977"/></g><g><title>Database</title><rect fill="#FFFFFF" height="349.3027" style="stroke:#181818;stroke-width:1;" width="10" x="514.2202" y="194.9082"/></g><g class="message" data-participant-1="User" data-participant-2="API"><polygon fill="#181818" points="252.3237,161.5977,262.3237,165.5977,252.3237,169.5977,256.3237,165.5977" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="38.1826" x2="258.3237" y1="165.5977" y2="165.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175.1699" x="63.6682" y="145.5449">POST /coupons/lock/{code}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="54.1519" x="124.1772" y="160.8555">{user_id}</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="502.2202,190.9082,512.2202,194.9082,502.2202,198.9082,506.2202,194.9082" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="274.3237" x2="508.2202" y1="194.9082" y2="194.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133.0278" x="327.7581" y="190.166">BEGIN TRANSACTION</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="502.2202,250.8398,512.2202,254.8398,502.2202,258.8398,506.2202,254.8398" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="274.3237" x2="508.2202" y1="254.8398" y2="254.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96.3003" x="346.1218" y="219.4766">SELECT coupon</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101.2134" x="343.6653" y="234.7871">WHERE code = ?</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="85.6235" x="351.4602" y="250.0977">FOR UPDATE</text></g><path d="M529,212.5635 L529,252.5635 L654,252.5635 L654,222.5635 L644,212.5635 L529,212.5635" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M644,212.5635 L644,222.5635 L654,222.5635 L644,212.5635" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104.3872" x="535" y="230.1318">Row locked until</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104.7998" x="535" y="245.4424">transaction ends</text><g class="message" data-participant-1="DB" data-participant-2="API"><polygon fill="#181818" points="285.3237,280.1504,275.3237,284.1504,285.3237,288.1504,281.3237,284.1504" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="279.3237" x2="513.2202" y1="284.1504" y2="284.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103.2764" x="342.6338" y="279.4082">Coupon (locked)</text></g><g class="message" data-participant-1="API" data-participant-2="API"><line style="stroke:#181818;stroke-width:1;" x1="274.3237" x2="316.3237" y1="344.082" y2="344.082"/><line style="stroke:#181818;stroke-width:1;" x1="316.3237" x2="316.3237" y1="344.082" y2="357.082"/><line style="stroke:#181818;stroke-width:1;" x1="275.3237" x2="316.3237" y1="357.082" y2="357.082"/><polygon fill="#181818" points="285.3237,353.082,275.3237,357.082,285.3237,361.082,281.3237,357.082" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="54.7739" x="320.53" y="308.7188">Validate:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129.3271" x="283.2534" y="324.0293">- State = ASSIGNED?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133.1865" x="281.3237" y="339.3398">- User owns coupon?</text></g><path d="M10,372.082 L72.1387,372.082 L72.1387,379.3926 L62.1387,389.3926 L10,389.3926 L10,372.082" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="224.75" style="stroke:#000000;stroke-width:1.5;" width="553.5527" x="10" y="372.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17.1387" x="25" y="385.6504">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="102.7974" x="87.1387" y="384.7168">[Validation Failed]</text><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="502.2202,406.7031,512.2202,410.7031,502.2202,414.7031,506.2202,410.7031" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="274.3237" x2="508.2202" y1="410.7031" y2="410.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66.1108" x="361.2166" y="405.9609">ROLLBACK</text></g><g class="message" data-participant-1="API" data-participant-2="User"><polygon fill="#181818" points="49.1826,436.0137,39.1826,440.0137,49.1826,444.0137,45.1826,440.0137" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="43.1826" x2="263.3237" y1="440.0137" y2="440.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.2412" x="105.6326" y="435.2715">400/403 Error</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="10" x2="563.5527" y1="449.0137" y2="449.0137"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="108.5122" x="15" y="459.6484">[Validation Passed]</text><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="502.2202,510.9004,512.2202,514.9004,502.2202,518.9004,506.2202,514.9004" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="274.3237" x2="508.2202" y1="514.9004" y2="514.9004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101.2261" x="343.6589" y="479.5371">UPDATE coupon</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124.7378" x="331.9031" y="494.8477">SET state='LOCKED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215.8965" x="286.3237" y="510.1582">SET lock_expires_at=NOW()+5min</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="507.2202,540.2109,517.2202,544.2109,507.2202,548.2109,511.2202,544.2109" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="274.3237" x2="513.2202" y1="544.2109" y2="544.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53.4536" x="370.0452" y="539.4688">COMMIT</text></g><g class="message" data-participant-1="API" data-participant-2="User"><polygon fill="#181818" points="49.1826,584.832,39.1826,588.832,49.1826,592.832,45.1826,588.832" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="43.1826" x2="263.3237" y1="588.832" y2="588.832"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47.3599" x="127.5732" y="568.7793">200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202.1411" x="50.1826" y="584.0898">{state: "LOCKED", expires_at: ...}</text></g><path d="M14,608.832 L14,709.832 L542,709.832 L542,618.832 L532,608.832 L14,608.832" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M532,608.832 L532,618.832 L542,618.832 L532,608.832" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="164.1694" x="122.5688" y="626.4004">Key Points for Interview:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214.1953" x="122.5688" y="641.7109">1. Temporary lock with expiration</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188.2334" x="122.5688" y="657.0215">2. User ownership verification</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208.127" x="122.5688" y="672.332">3. State machine validation (FSM)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199.5259" x="122.5688" y="687.6426">4. Pessimistic locking for safety</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="302.415" x="122.5688" y="702.9531">5. Can be unlocked or progressed to REDEEMED</text><!--SRC=[RLFRRjf047tVhnZHXm0DXkRoWaGZi9SKSJ6odUO5AThO4rZ5x5Bl0esY_7jdRG9KhInXitFcd9api-PLgeqen1gUHVgwBFHMPRxETG5VXjmzp1mH1dzjKQKuHMF44lkvN2f8KLai6BFIvWWJdRw2hxSRhU25I2BCSBsnalxMVyZbgZN17UODnaHgAVnWA9N8hKpbHYWBjVvyL0DXWDui4rOy2uDG2mvVPIWOCEOIeVNTmQ0Byp1Ee9sMigQTKmtjzrHd-B5Gxrj2FidimodAdR1OKZENIFd1WD87_7uqWoJgp-A-dup2sGdhjCwXCPzmFu5AQg4UV_28WvE27jmjLBCv32Duc0VzX3URJ6cYAAXjom0YlGTN6cQmLLRcT6GBeOpJ8djGPORH3xWanaYjTUplO6YzIcySIwgYFqKkoIhiBbGBOklAxa4_ZaVtCnxSkSFIBRrNvb3u7VcVsyz4fpuKCiUCIW8uRpSA9vD1tn-V0XGfsRfmq-cqRphNm8j25mnpcjCPuLmOyn_2ofgZVp5FmBYAUnUJq1_puA8wSuq-uU-DBD0y2TkRXO_rnjVRjLGbup-qVZYTZfBoECFpuVsDFXL_rUb0EARrADMxKAlaQvTmKks2vtaVRYRiZBJSddAmUeVL1bzMIitc6DzWhgMofbp-aRiPEudxBkq2m3SF4heCkX35MzaXxALTLOAbQOIvyex3miAiv0P8HBx8z1DmxHr6l1RfIYg4tSdp-Z2UDWXpuy6ShgXSIqCNgvIIQbcMPCGBsZV2t7hW2mNFICjus4eARmgzfEPfSc0rH3pWVCg3qrh-0G00]--></g></svg>