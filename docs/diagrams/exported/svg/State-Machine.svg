<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="STATE" height="790px" preserveAspectRatio="none" style="width:616px;height:790px;background:#FEFEFE;" version="1.1" viewBox="0 0 616 790" width="616px" zoomAndPan="magnify"><title>Coupon Lifecycle - State Machine</title><defs/><g><rect fill="#FEFEFE" height="790" style="stroke:none;stroke-width:1;" width="616" x="0" y="0"/><g class="title" data-source-line="10"><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="240.7549" x="180.7962" y="23.5352">Coupon Lifecycle - State Machine</text></g><ellipse cx="122.59" cy="53.4883" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1;"/><g id="UNASSIGNED"><rect fill="#ADD8E6" height="64.7539" rx="12.5" ry="12.5" style="stroke:#000080;stroke-width:0.5;" width="200.1055" x="22.54" y="140.4883"/><line style="stroke:#000080;stroke-width:0.5;" x1="22.54" x2="222.6455" y1="166.9766" y2="166.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87.3496" x="78.9179" y="159.0234">UNASSIGNED</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="111.8613" x="27.54" y="183.5781">Entry: code created</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="180.1055" x="27.54" y="197.7109">State: Available for assignment</text></g><g id="ASSIGNED"><rect fill="#ADD8E6" height="78.8867" rx="12.5" ry="12.5" style="stroke:#000080;stroke-width:0.5;" width="166.1387" x="39.52" y="282.2383"/><line style="stroke:#000080;stroke-width:0.5;" x1="39.52" x2="205.6587" y1="308.7266" y2="308.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.3066" x="88.936" y="300.7734">ASSIGNED</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="117.668" x="44.52" y="325.3281">Entry: user assigned</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="138.2285" x="44.52" y="339.4609">State: Reserved for user</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="146.1387" x="44.52" y="353.5937">Exit: ownership validated</text></g><g id="LOCKED"><rect fill="#ADD8E6" height="93.0195" rx="12.5" ry="12.5" style="stroke:#000080;stroke-width:0.5;" width="202.4668" x="21.36" y="438.1283"/><line style="stroke:#000080;stroke-width:0.5;" x1="21.36" x2="223.8268" y1="464.6166" y2="464.6166"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.2412" x="94.9728" y="456.6634">LOCKED</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="149.2441" x="26.36" y="481.2181">Entry: redemption started</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="148.4355" x="26.36" y="495.3509">State: Temporarily locked</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="182.4668" x="26.36" y="509.4837">Duration: Configurable timeout</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="155.707" x="26.36" y="523.6166">Exit: validate user &amp; expiry</text></g><g id="REDEEMED"><rect fill="#ADD8E6" height="93.0195" rx="12.5" ry="12.5" style="stroke:#000080;stroke-width:0.5;" width="231.1836" x="7" y="608.1483"/><line style="stroke:#000080;stroke-width:0.5;" x1="7" x2="238.1836" y1="634.6366" y2="634.6366"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72.2354" x="86.4741" y="626.6834">REDEEMED</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="169.5293" x="12" y="651.2381">Entry: redemption completed</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="98.4727" x="12" y="665.3709">State: Permanent</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="125.5723" x="12" y="679.5038">Action: Log to history</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="211.1836" x="12" y="693.6366">Count: Increment redemption_count</text></g><ellipse cx="122.59" cy="773.1683" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1;"/><ellipse cx="122.59" cy="773.1683" fill="#222222" rx="6" ry="6" style="stroke:#222222;stroke-width:1;"/><g class="entity" data-entity="GMN2" data-source-line="38" data-uid="ent0003" id="entity_GMN2"><path d="M258.1,144.8983 L258.1,168.8683 L223,172.8683 L258.1,176.8683 L258.1,200.8299 A0,0 0 0 0 258.1,200.8299 L395.0844,200.8299 A0,0 0 0 0 395.0844,200.8299 L395.0844,154.8983 L385.0844,144.8983 L258.1,144.8983 A0,0 0 0 0 258.1,144.8983" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M385.0844,144.8983 L385.0844,154.8983 L395.0844,154.8983 L385.0844,144.8983" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107.6245" x="264.1" y="162.4666">Initial state after:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115.9844" x="264.1" y="177.7772">- Code generation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.5078" x="264.1" y="193.0877">- Code upload</text></g><g class="entity" data-entity="GMN5" data-source-line="44" data-uid="ent0006" id="entity_GMN5"><path d="M377.84,286.0683 L377.84,317.6883 L205.92,321.6883 L377.84,325.6883 L377.84,357.3105 A0,0 0 0 0 377.84,357.3105 L609.3473,357.3105 A0,0 0 0 0 609.3473,357.3105 L609.3473,296.0683 L599.3473,286.0683 L377.84,286.0683 A0,0 0 0 0 377.84,286.0683" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M599.3473,286.0683 L599.3473,296.0683 L609.3473,296.0683 L599.3473,286.0683" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="73.9692" x="383.84" y="303.6366">Validations:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81.0342" x="383.84" y="318.9472">- User exists</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210.5073" x="383.84" y="334.2577">- Max assignments not exceeded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97.7222" x="383.84" y="349.5683">- Book is active</text></g><g class="entity" data-entity="GMN8" data-source-line="51" data-uid="ent0009" id="entity_GMN8"><path d="M258.88,441.3583 L258.88,480.6383 L224.03,484.6383 L258.88,488.6383 L258.88,527.911 A0,0 0 0 0 258.88,527.911 L456.3004,527.911 A0,0 0 0 0 456.3004,527.911 L456.3004,451.3583 L446.3004,441.3583 L258.88,441.3583 A0,0 0 0 0 258.88,441.3583" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M446.3004,441.3583 L446.3004,451.3583 L456.3004,451.3583 L446.3004,441.3583" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132.374" x="264.88" y="458.9266">Timeout mechanism:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159.1738" x="264.88" y="474.2372">- locked_until timestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154.7241" x="264.88" y="489.5477">- Auto-unlock on expiry</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132.4375" x="264.88" y="504.8583">- Prevents deadlocks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176.4204" x="264.88" y="520.1688">- PostgreSQL advisory locks</text></g><g class="entity" data-entity="GMN11" data-source-line="59" data-uid="ent0012" id="entity_GMN11"><path d="M273.03,619.0383 L273.03,650.6583 L238.4,654.6583 L273.03,658.6583 L273.03,690.2805 A0,0 0 0 0 273.03,690.2805 L458.1487,690.2805 A0,0 0 0 0 458.1487,690.2805 L458.1487,629.0383 L448.1487,619.0383 L273.03,619.0383 A0,0 0 0 0 273.03,619.0383" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M448.1487,619.0383 L448.1487,629.0383 L458.1487,629.0383 L448.1487,619.0383" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68.7324" x="279.03" y="636.6066">Final state:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134.3481" x="279.03" y="651.9172">- Cannot be reversed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125.2646" x="279.03" y="667.2277">- Audit trail created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164.1187" x="279.03" y="682.5383">- Multi-redemption check</text></g><!--link *start* to UNASSIGNED--><g class="link" data-entity-1=".start." data-entity-2="UNASSIGNED" data-source-line="12" data-uid="lnk4" id="link_.start._UNASSIGNED"><path d="M122.59,63.6983 C122.59,79.9683 122.59,108.4883 122.59,134.1883" fill="none" id="*start*-to-UNASSIGNED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="122.59,140.1883,126.59,131.1883,122.59,135.1883,118.59,131.1883,122.59,140.1883" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101.2515" x="123.59" y="107.0566">Code Generated</text></g><!--link UNASSIGNED to ASSIGNED--><g class="link" data-entity-1="UNASSIGNED" data-entity-2="ASSIGNED" data-source-line="14" data-uid="lnk6" id="link_UNASSIGNED_ASSIGNED"><path d="M122.59,205.7283 C122.59,228.0683 122.59,252.0883 122.59,275.8383" fill="none" id="UNASSIGNED-to-ASSIGNED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="122.59,281.8383,126.59,272.8383,122.59,276.8383,118.59,272.8383,122.59,281.8383" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94.5166" x="123.59" y="248.8066">assign(user_id)</text></g><!--link ASSIGNED to LOCKED--><g class="link" data-entity-1="ASSIGNED" data-entity-2="LOCKED" data-source-line="18" data-uid="lnk8" id="link_ASSIGNED_LOCKED"><path d="M71.66,361.5183 C59.93,375.2383 52.47,391.4283 58.59,408.1283 C62.44,418.6183 64.8625,423.8464 71.7025,432.9764" fill="none" id="ASSIGNED-to-LOCKED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="75.3,437.7783,73.105,428.1771,72.3021,433.7767,66.7025,432.9738,75.3,437.7783" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80.1519" x="59.59" y="404.6966">lock(user_id)</text></g><!--link LOCKED to ASSIGNED--><g class="link" data-entity-1="LOCKED" data-entity-2="ASSIGNED" data-source-line="25" data-uid="lnk12" id="link_LOCKED_ASSIGNED"><path d="M140.76,437.8083 C144.67,423.0083 147,406.4583 144.59,391.1283 C143.06,381.3883 142.1841,376.8638 139.2041,367.3538" fill="none" id="LOCKED-to-ASSIGNED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="137.41,361.6283,136.2842,371.4126,138.9051,366.3995,143.9181,369.0204,137.41,361.6283" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96.2876" x="146.57" y="404.6966">unlock(user_id)</text></g><!--link ASSIGNED to ASSIGNED--><g class="link" data-entity-1="ASSIGNED" data-entity-2="ASSIGNED" data-source-line="19" data-uid="lnk9" id="link_ASSIGNED_ASSIGNED"><path d="M206.16,307.3483 C226,308.4983 240.66,313.2783 240.66,321.6883 C240.66,330.0983 231.9899,334.5311 212.1499,335.6811" fill="none" id="ASSIGNED-to-ASSIGNED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="206.16,336.0283,215.3764,339.5008,211.1516,335.7389,214.9135,331.5142,206.16,336.0283" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107.0786" x="246.66" y="326.7566">reassign(user_id)</text></g><!--link LOCKED to REDEEMED--><g class="link" data-entity-1="LOCKED" data-entity-2="REDEEMED" data-source-line="24" data-uid="lnk11" id="link_LOCKED_REDEEMED"><path d="M122.59,531.5483 C122.59,555.2583 122.59,578.0983 122.59,601.7983" fill="none" id="LOCKED-to-REDEEMED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="122.59,607.7983,126.59,598.7983,122.59,602.7983,118.59,598.7983,122.59,607.7983" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101.5181" x="123.59" y="574.7166">redeem(user_id)</text></g><!--link REDEEMED to *end*--><g class="link" data-entity-1="REDEEMED" data-entity-2=".end." data-source-line="31" data-uid="lnk14" id="link_REDEEMED_.end."><path d="M122.59,701.3683 C122.59,723.5583 122.59,742.2883 122.59,755.8583" fill="none" id="REDEEMED-to-*end*" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="122.59,761.8583,126.59,752.8583,122.59,756.8583,118.59,752.8583,122.59,761.8583" style="stroke:#000080;stroke-width:1;"/></g><!--SRC=[TLHTRzem57tthxZJfAcTn1_WOL9QqWeDkgxGlKmJSkrBi4Zio7PIqBJ_lcixW04rUOhlkUUS- -5yahXM6c6nB9RbpUuMdESUOSUOsohTSiiRUEDYMrdJQNblQcFXyqCPtWoHaluoeEVk0ZrJrSRVrHscgB4IROeyyNuV3mjhpNjszeynhtoDS6-wrcYYMAFO2peOmI9ApRdOa6t6Vd_z0wFHDtXzAXQBwUDJEO4nfKc4HzHe2IiPou81co6vSwhIDvr3krBobftHbDhR_HX4O1CM8zSP87ePGz5pLVCtihUc2X9bWzepTYOx-t7_FQRLHcnFaXzP8y4BSzVMGcWG96_NpbwG03tAQ2o0ppXsoe_1l5ERt4QrqFDQoTImmMfmz59Eod8-E9A8pSbFXifeEtrUtx7imNDWQLglQAwqDZRe7I63xIK1ZELMrVlOh1mowMYeb1ochDUgei_GUQyQD9tFr69rXvfIfxu0xbfbzumTgmhcQOTOLkQrJs6QjiRWD8CDNf_HDbo7QMUnGYIBCrE1Dx1HpXkIpH2qsPhyJJKjLjYLJ6ubGemnRSYt3RS7p3fRSBeoKwsyulLmx_ZQentJyIXjVfKsdwXEPrrR6ouPQWc1zv8zu_wLMaRPBd6-XjRXZcfmyNlETzcIky17OO5KW8o0EsEse1nmwaAF7sgcKL76CiqE6XGRhfLhacwQ_8fweUeuNwgsQMEewBmPfKK3ciymrH1vjjX7LnAv3F7a-TauNrbS_9m1bxroD0r8qO_S7MP5wGzA7tezT9dhKFGRmKdDkg7kefFAWxVqDpZ-BsB3kjghKRvF6nJRa_9_]--></g></svg>