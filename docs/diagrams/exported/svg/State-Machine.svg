<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="STATE" height="702px" preserveAspectRatio="none" style="width:1321px;height:702px;background:#FEFEFE;" version="1.1" viewBox="0 0 1321 702" width="1321px" zoomAndPan="magnify"><title>Coupon Lifecycle - State Machine</title><defs/><g><rect fill="#FEFEFE" height="702" style="stroke:none;stroke-width:1;" width="1321" x="0" y="0"/><g class="title" data-source-line="10"><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="240.7549" x="533.4919" y="23.5352">Coupon Lifecycle - State Machine</text></g><ellipse cx="356.18" cy="53.4883" fill="#222222" rx="10" ry="10" style="stroke:#222222;stroke-width:1;"/><g id="UNASSIGNED"><rect fill="#ADD8E6" height="64.7539" rx="12.5" ry="12.5" style="stroke:#000080;stroke-width:0.5;" width="200.1055" x="256.12" y="140.4883"/><line style="stroke:#000080;stroke-width:0.5;" x1="256.12" x2="456.2255" y1="166.9766" y2="166.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87.3496" x="312.4979" y="159.0234">UNASSIGNED</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="111.8613" x="261.12" y="183.5781">Entry: code created</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="180.1055" x="261.12" y="197.7109">State: Available for assignment</text></g><g id="ASSIGNED"><rect fill="#ADD8E6" height="78.8867" rx="12.5" ry="12.5" style="stroke:#000080;stroke-width:0.5;" width="166.1387" x="273.11" y="309.0383"/><line style="stroke:#000080;stroke-width:0.5;" x1="273.11" x2="439.2487" y1="335.5266" y2="335.5266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.3066" x="322.526" y="327.5734">ASSIGNED</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="117.668" x="278.11" y="352.1281">Entry: user assigned</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="138.2285" x="278.11" y="366.2609">State: Reserved for user</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="146.1387" x="278.11" y="380.3938">Exit: ownership validated</text></g><g id="LOCKED"><rect fill="#ADD8E6" height="93.0195" rx="12.5" ry="12.5" style="stroke:#000080;stroke-width:0.5;" width="220.3555" x="7" y="513.7883"/><line style="stroke:#000080;stroke-width:0.5;" x1="7" x2="227.3555" y1="540.2766" y2="540.2766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55.2412" x="89.5571" y="532.3234">LOCKED</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="126.8672" x="12" y="556.8781">Entry: temporary hold</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="145.418" x="12" y="571.0109">State: Demo/testing only</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="140.7949" x="12" y="585.1438">Duration: 5 min timeout</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="200.3555" x="12" y="599.2766">Note: Cannot redeem while locked</text></g><g id="REDEEMED"><rect fill="#ADD8E6" height="107.1523" rx="12.5" ry="12.5" style="stroke:#000080;stroke-width:0.5;" width="277.8477" x="817.25" y="506.7283"/><line style="stroke:#000080;stroke-width:0.5;" x1="817.25" x2="1095.0977" y1="533.2166" y2="533.2166"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72.2354" x="920.0562" y="525.2634">REDEEMED</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="169.5293" x="822.25" y="549.8181">Entry: redemption completed</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="98.4727" x="822.25" y="563.9509">State: Permanent</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="125.5723" x="822.25" y="578.0838">Action: Log to history</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="211.1836" x="822.25" y="592.2166">Count: Increment redemption_count</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="257.8477" x="822.25" y="606.3494">Protection: Advisory lock during redemption</text></g><ellipse cx="956.18" cy="685.8783" fill="none" rx="11" ry="11" style="stroke:#222222;stroke-width:1;"/><ellipse cx="956.18" cy="685.8783" fill="#222222" rx="6" ry="6" style="stroke:#222222;stroke-width:1;"/><g class="entity" data-entity="GMN2" data-source-line="39" data-uid="ent0003" id="entity_GMN2"><path d="M491.69,144.8983 L491.69,168.8683 L456.58,172.8683 L491.69,176.8683 L491.69,200.8299 A0,0 0 0 0 491.69,200.8299 L628.6744,200.8299 A0,0 0 0 0 628.6744,200.8299 L628.6744,154.8983 L618.6744,144.8983 L491.69,144.8983 A0,0 0 0 0 491.69,144.8983" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M618.6744,144.8983 L618.6744,154.8983 L628.6744,154.8983 L618.6744,144.8983" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107.6245" x="497.69" y="162.4666">Initial state after:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115.9844" x="497.69" y="177.7772">- Code generation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.5078" x="497.69" y="193.0877">- Code upload</text></g><g class="entity" data-entity="GMN5" data-source-line="45" data-uid="ent0006" id="entity_GMN5"><path d="M610.87,282.2383 L610.87,344.4883 L439.42,348.4883 L610.87,352.4883 L610.87,414.7227 A0,0 0 0 0 610.87,414.7227 L1003.4808,414.7227 A0,0 0 0 0 1003.4808,414.7227 L1003.4808,292.2383 L993.4808,282.2383 L610.87,282.2383 A0,0 0 0 0 610.87,282.2383" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M993.4808,282.2383 L993.4808,292.2383 L1003.4808,292.2383 L993.4808,282.2383" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.4595" x="616.87" y="299.8066">Two redemption paths:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228.5029" x="616.87" y="315.1172">1. ASSIGNED &#8594; REDEEMED (primary)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="371.6108" x="616.87" y="330.4277">2. ASSIGNED &#8594; LOCKED &#8594; ASSIGNED &#8594; REDEEMED (demo)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4.1133" x="616.87" y="345.7383">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171.7422" x="616.87" y="361.0488">Lock is optional - used for:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139.4707" x="616.87" y="376.3594">- Testing concurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197.6978" x="616.87" y="391.6699">- Demonstrating state machine</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210.7168" x="616.87" y="406.9805">- Simulating multi-step checkout</text></g><g class="entity" data-entity="GMN8" data-source-line="56" data-uid="ent0009" id="entity_GMN8"><path d="M494.46,509.3683 L494.46,611.2316 L781.8902,611.2316 L781.8902,519.3683 L771.8902,509.3683 L494.46,509.3683" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M771.8902,509.3683 L771.8902,519.3683 L781.8902,519.3683 L771.8902,509.3683" fill="#FEFFDD" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="243.439" x="500.46" y="526.9366">Advisory locks prevent race conditions</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="266.4302" x="500.46" y="542.2472">during redemption, not the LOCKED state.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4.1133" x="500.46" y="557.5577">&#160;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260.4697" x="500.46" y="572.8683">LOCKED state is purely for demo/testing.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254.3506" x="500.46" y="588.1788">Redemption uses internal advisory locks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172.542" x="500.46" y="603.4894">regardless of coupon state.</text></g><g class="entity" data-entity="GMN11" data-source-line="65" data-uid="ent0012" id="entity_GMN11"><path d="M262.47,517.0283 L262.47,556.2983 L227.74,560.2983 L262.47,564.2983 L262.47,603.581 A0,0 0 0 0 262.47,603.581 L459.8904,603.581 A0,0 0 0 0 459.8904,603.581 L459.8904,527.0283 L449.8904,517.0283 L262.47,517.0283 A0,0 0 0 0 262.47,517.0283" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M449.8904,517.0283 L449.8904,527.0283 L459.8904,527.0283 L449.8904,517.0283" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132.374" x="268.47" y="534.5966">Timeout mechanism:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159.1738" x="268.47" y="549.9072">- locked_until timestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154.7241" x="268.47" y="565.2177">- Auto-unlock on expiry</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="132.4375" x="268.47" y="580.5283">- Prevents deadlocks</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176.4204" x="268.47" y="595.8388">- PostgreSQL advisory locks</text></g><g class="entity" data-entity="GMN14" data-source-line="73" data-uid="ent0015" id="entity_GMN14"><path d="M1129.62,524.6783 L1129.62,556.2983 L1095.41,560.2983 L1129.62,564.2983 L1129.62,595.9205 A0,0 0 0 0 1129.62,595.9205 L1314.7387,595.9205 A0,0 0 0 0 1314.7387,595.9205 L1314.7387,534.6783 L1304.7387,524.6783 L1129.62,524.6783 A0,0 0 0 0 1129.62,524.6783" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1304.7387,524.6783 L1304.7387,534.6783 L1314.7387,534.6783 L1304.7387,524.6783" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68.7324" x="1135.62" y="542.2466">Final state:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134.3481" x="1135.62" y="557.5572">- Cannot be reversed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125.2646" x="1135.62" y="572.8677">- Audit trail created</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164.1187" x="1135.62" y="588.1783">- Multi-redemption check</text></g><!--link *start* to UNASSIGNED--><g class="link" data-entity-1=".start." data-entity-2="UNASSIGNED" data-source-line="12" data-uid="lnk4" id="link_.start._UNASSIGNED"><path d="M356.18,63.6983 C356.18,79.9683 356.18,108.4883 356.18,134.1783" fill="none" id="*start*-to-UNASSIGNED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="356.18,140.1783,360.18,131.1783,356.18,135.1783,352.18,131.1783,356.18,140.1783" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101.2515" x="357.18" y="107.0566">Code Generated</text></g><!--link UNASSIGNED to ASSIGNED--><g class="link" data-entity-1="UNASSIGNED" data-entity-2="ASSIGNED" data-source-line="14" data-uid="lnk6" id="link_UNASSIGNED_ASSIGNED"><path d="M356.18,205.7083 C356.18,234.6883 356.18,271.5483 356.18,302.5483" fill="none" id="UNASSIGNED-to-ASSIGNED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="356.18,308.5483,360.18,299.5483,356.18,303.5483,352.18,299.5483,356.18,308.5483" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94.5166" x="357.18" y="248.8066">assign(user_id)</text></g><!--link ASSIGNED to LOCKED--><g class="link" data-entity-1="ASSIGNED" data-entity-2="LOCKED" data-source-line="18" data-uid="lnk8" id="link_ASSIGNED_LOCKED"><path d="M272.88,358.4783 C217.82,369.2383 149.51,392.8583 114.18,444.7283 C100.74,464.4583 99.6116,484.9437 103.2116,507.4337" fill="none" id="ASSIGNED-to-LOCKED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="104.16,513.3583,106.6872,503.8392,103.3697,508.4211,98.7878,505.1037,104.16,513.3583" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80.1519" x="173.6768" y="458.2966">lock(user_id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="197.1455" x="115.18" y="473.6072">[OPTIONAL - for demo/testing]</text></g><!--link LOCKED to ASSIGNED--><g class="link" data-entity-1="LOCKED" data-entity-2="ASSIGNED" data-source-line="25" data-uid="lnk12" id="link_LOCKED_ASSIGNED"><path d="M227.8,513.7683 C273.89,494.7683 316.94,476.9883 317.18,476.7283 C339.26,452.4583 347.9489,421.9017 352.1089,394.2017" fill="none" id="LOCKED-to-ASSIGNED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="353,388.2683,347.7077,396.5744,352.2574,393.2128,355.619,397.7625,353,388.2683" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96.2876" x="337.52" y="465.7966">unlock(user_id)</text></g><!--link ASSIGNED to REDEEMED--><g class="link" data-entity-1="ASSIGNED" data-entity-2="REDEEMED" data-source-line="19" data-uid="lnk10" id="link_ASSIGNED_REDEEMED"><path d="M439.61,378.6583 C537.17,412.7783 694.5063,467.7978 811.3263,508.6478" fill="none" id="ASSIGNED-to-REDEEMED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="816.99,510.6283,809.8148,503.8817,812.2702,508.9779,807.1741,511.4333,816.99,510.6283" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101.5181" x="753.9349" y="458.2966">redeem(user_id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187.5479" x="710.92" y="473.6072">[DIRECT PATH - primary flow]</text></g><!--link ASSIGNED to ASSIGNED--><g class="link" data-entity-1="ASSIGNED" data-entity-2="ASSIGNED" data-source-line="20" data-uid="lnk11" id="link_ASSIGNED_ASSIGNED"><path d="M439.75,329.2083 C459.58,330.7583 474.25,337.1783 474.25,348.4883 C474.25,359.7883 465.5618,365.7407 445.7318,367.2907" fill="none" id="ASSIGNED-to-ASSIGNED" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="439.75,367.7583,449.0343,371.0448,444.7348,367.3686,448.4109,363.0691,439.75,367.7583" style="stroke:#000080;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107.0786" x="480.25" y="353.5566">reassign(user_id)</text></g><!--link REDEEMED to *end*--><g class="link" data-entity-1="REDEEMED" data-entity-2=".end." data-source-line="31" data-uid="lnk14" id="link_REDEEMED_.end."><path d="M956.18,614.0683 C956.18,636.8983 956.18,655.4083 956.18,668.7683" fill="none" id="REDEEMED-to-*end*" style="stroke:#000080;stroke-width:1;"/><polygon fill="#000080" points="956.18,674.7683,960.18,665.7683,956.18,669.7683,952.18,665.7683,956.18,674.7683" style="stroke:#000080;stroke-width:1;"/></g><!--link LOCKED to GMN8--><g class="link" data-entity-1="LOCKED" data-entity-2="GMN8" data-source-line="56" data-uid="lnk10" id="link_LOCKED_GMN8"><path d="M169.02,513.4783 C195.13,493.0183 228.46,471.3083 262.68,460.7283 C346.32,434.8483 374.94,438.6883 459.68,460.7283 C496.94,470.4183 534.68,489.7783 565.8,508.8783" fill="none" id="LOCKED-GMN8" style="stroke:#000080;stroke-width:1;stroke-dasharray:7,7;"/></g><!--SRC=[XLN1RXiv3BthAxZOIxAeMtI1lVXGO6AxhL77SMFtr1Q18j4U8JFIGDBOCOfUzmFs4_ib9KVZM7OGhEE38LAFxv6FoXyQryOYB5V5QdBnU0aXoeZmA4HuCBQHNjPmBzN3nhlMwf6hd8S_tq_uByj8btu8eC_LMVRCRCfuLRMOeivhz2aobzjzTrXuxtRPsKyXeeaLmiYrZRC4iKQrLtGmW6LNwbggacWByVMlxp0Ol8ClysAvd7wOJyOmf6iQuGDQz9IhXSY2d9jboX3Cnbwq0VsTqPVY16PYezyFGJ6QyjXXdIHqN8PGRAMfv3tHMvE215cZZKASb9tTZ3vrrogd7fvAVhDVRnQhwSsyc94w1j1OkpSHGpHsy_qKudOodaokEn2F6h7EOSRJsybe1OjYzP6G6czgwVUmhjpk32LJGAhEEl1SFuTwLTI0v_9laHAsg3lod7o2yMZY4DoEPX5Aqy1MLaQdgVJzE6FKsfFsYAUkzMmYretphAnqbJw6UpBZh7dWRBK_PenRieDnTWZ_G6qiH5EZQ-CnOUuOOIIjTR7lB-nAGtDbIapvgVzCcgmdie7q_FXUtN0TCaxTLCXQixIUvm9zBIsR98iLAl6RkGr41wK9qVbzda4BOQcVKqj-P8jbvUuKn_BaXIT1FMIXjoOGM2S5TEkvFyVBGf1c1C-x2cwThHCjwDIQQ6JLRxbSH_H3EXwaFTkaFMEGfxEsgPpK0gq6nZr7px1NEvUth96n30p-zlNH5B_-_U_e_8lUs9UKzFTPKZz9_ld2PTujladV6JV2171TPP8tOFDsBaxgLhsBbBEgzHwjsdVdR34R8ckcQ6fAtRz775-QkgrIa7v4CmWH6r0bgWUssqjDIUG9uMHKWHOPjzsafKBceWtp3PJuR8gl61XYYOTETEHUztgp8zRTj1wh_RCNXxDlZmEXbWGmbaREBP8dr2ZJuqPwNM48B46bvxgl-hz2Lsa1eKPLIcj2dVgUbksEp6ogRaa9hswwKD56DqWl12qtu6DZV1hA8dKfa1Qf3-pes8MuyRZyF3ld_XAxWrVe-djZ3wxl_PwUXdjAfsgUtDApefa06OBu7lvFyFbrD_tyGM0F72l_1W00]--></g></svg>