<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="851px" preserveAspectRatio="none" style="width:534px;height:851px;background:#FEFEFE;" version="1.1" viewBox="0 0 534 851" width="534px" zoomAndPan="magnify"><title>Redeem Coupon - Permanent Operation (High-Level)</title><defs/><g><rect fill="#FEFEFE" height="851" style="stroke:none;stroke-width:1;" width="534" x="0" y="0"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="384.4736" x="75.8291" y="28.5352">Redeem Coupon - Permanent Operation (High-Level)</text><g><title>API</title><rect fill="#FFFFFF" height="482.8555" style="stroke:#181818;stroke-width:1;" width="10" x="253.7188" y="165.5977"/></g><g><title>Database</title><rect fill="#FFFFFF" height="393.9238" style="stroke:#181818;stroke-width:1;" width="10" x="477.7993" y="194.9082"/></g><rect fill="none" height="269.3711" style="stroke:#000000;stroke-width:1.5;" width="517.1318" x="10" y="372.082"/><g><title>User</title><rect fill="#000000" fill-opacity="0.00000" height="651.3398" width="8" x="34.1826" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="38" x2="38" y1="118.9766" y2="770.3164"/></g><g><title>API</title><rect fill="#000000" fill-opacity="0.00000" height="651.3398" width="8" x="254.7188" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="258.0034" x2="258.0034" y1="118.9766" y2="770.3164"/></g><g><title>Database</title><rect fill="#000000" fill-opacity="0.00000" height="651.3398" width="8" x="478.7993" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="482.4668" x2="482.4668" y1="118.9766" y2="770.3164"/></g><g class="participant participant-head" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.3652" x="20" y="116.0234">User</text><ellipse cx="38.1826" cy="50.9883" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M38.1826,58.9883 L38.1826,85.9883 M25.1826,66.9883 L51.1826,66.9883 M38.1826,85.9883 L25.1826,100.9883 M38.1826,85.9883 L51.1826,100.9883" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.3652" x="20" y="782.8516">User</text><ellipse cx="38.1826" cy="794.3047" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M38.1826,802.3047 L38.1826,829.3047 M25.1826,810.3047 L51.1826,810.3047 M38.1826,829.3047 L25.1826,844.3047 M38.1826,829.3047 L51.1826,844.3047" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="API"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="35.4307" x="241.0034" y="87.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.4307" x="248.0034" y="108.0234">API</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="35.4307" x="241.0034" y="769.3164"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.4307" x="248.0034" y="789.8516">API</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62.665" x="448.4668" y="116.0234">Database</text><path d="M464.7993,66.4883 C464.7993,56.4883 482.7993,56.4883 482.7993,56.4883 C482.7993,56.4883 500.7993,56.4883 500.7993,66.4883 L500.7993,92.4883 C500.7993,102.4883 482.7993,102.4883 482.7993,102.4883 C482.7993,102.4883 464.7993,102.4883 464.7993,92.4883 L464.7993,66.4883" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M464.7993,66.4883 C464.7993,76.4883 482.7993,76.4883 482.7993,76.4883 C482.7993,76.4883 500.7993,76.4883 500.7993,66.4883" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62.665" x="448.4668" y="782.8516">Database</text><path d="M464.7993,795.8047 C464.7993,785.8047 482.7993,785.8047 482.7993,785.8047 C482.7993,785.8047 500.7993,785.8047 500.7993,795.8047 L500.7993,821.8047 C500.7993,831.8047 482.7993,831.8047 482.7993,831.8047 C482.7993,831.8047 464.7993,831.8047 464.7993,821.8047 L464.7993,795.8047" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M464.7993,795.8047 C464.7993,805.8047 482.7993,805.8047 482.7993,805.8047 C482.7993,805.8047 500.7993,805.8047 500.7993,795.8047" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g><title>API</title><rect fill="#FFFFFF" height="482.8555" style="stroke:#181818;stroke-width:1;" width="10" x="253.7188" y="165.5977"/></g><g><title>Database</title><rect fill="#FFFFFF" height="393.9238" style="stroke:#181818;stroke-width:1;" width="10" x="477.7993" y="194.9082"/></g><g class="message" data-participant-1="User" data-participant-2="API"><polygon fill="#181818" points="241.7188,161.5977,251.7188,165.5977,241.7188,169.5977,245.7188,165.5977" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="38.1826" x2="247.7188" y1="165.5977" y2="165.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196.5361" x="47.6826" y="145.5449">POST /coupons/redeem/{code}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121.2021" x="85.3496" y="160.8555">{user_id, metadata}</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="465.7993,190.9082,475.7993,194.9082,465.7993,198.9082,469.7993,194.9082" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="263.7188" x2="471.7993" y1="194.9082" y2="194.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133.0278" x="304.2451" y="190.166">BEGIN TRANSACTION</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="465.7993,235.5293,475.7993,239.5293,465.7993,243.5293,469.7993,239.5293" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="263.7188" x2="471.7993" y1="239.5293" y2="239.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.0806" x="275.7188" y="219.4766">SELECT coupon + book config</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="85.6235" x="327.9473" y="234.7871">FOR UPDATE</text></g><g class="message" data-participant-1="DB" data-participant-2="API"><polygon fill="#181818" points="274.7188,264.8398,264.7188,268.8398,274.7188,272.8398,270.7188,268.8398" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="268.7188" x2="476.7993" y1="268.8398" y2="268.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118.3711" x="311.5735" y="264.0977">Coupon + Settings</text></g><g class="message" data-participant-1="API" data-participant-2="API"><line style="stroke:#181818;stroke-width:1;" x1="263.7188" x2="305.7188" y1="344.082" y2="344.082"/><line style="stroke:#181818;stroke-width:1;" x1="305.7188" x2="305.7188" y1="344.082" y2="357.082"/><line style="stroke:#181818;stroke-width:1;" x1="264.7188" x2="305.7188" y1="357.082" y2="357.082"/><polygon fill="#181818" points="274.7188,353.082,264.7188,357.082,274.7188,361.082,270.7188,357.082" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="54.7739" x="325.5403" y="293.4082">Validate:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133.1865" x="286.334" y="308.7188">- User owns coupon?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.584" x="307.1353" y="324.0293">- Not expired?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164.417" x="270.7188" y="339.3398">- Under redemption limit?</text></g><path d="M10,372.082 L72.1387,372.082 L72.1387,379.3926 L62.1387,389.3926 L10,389.3926 L10,372.082" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="269.3711" style="stroke:#000000;stroke-width:1.5;" width="517.1318" x="10" y="372.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17.1387" x="25" y="385.6504">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="102.7974" x="87.1387" y="384.7168">[Validation Failed]</text><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="465.7993,406.7031,475.7993,410.7031,465.7993,414.7031,469.7993,410.7031" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="263.7188" x2="471.7993" y1="410.7031" y2="410.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66.1108" x="337.7036" y="405.9609">ROLLBACK</text></g><g class="message" data-participant-1="API" data-participant-2="User"><polygon fill="#181818" points="49.1826,436.0137,39.1826,440.0137,49.1826,444.0137,45.1826,440.0137" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="43.1826" x2="252.7188" y1="440.0137" y2="440.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.2412" x="100.3301" y="435.2715">400/403 Error</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="10" x2="527.1318" y1="449.0137" y2="449.0137"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="108.5122" x="15" y="459.6484">[Validation Passed]</text><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="465.7993,510.9004,475.7993,514.9004,465.7993,518.9004,469.7993,514.9004" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="263.7188" x2="471.7993" y1="514.9004" y2="514.9004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101.2261" x="320.146" y="479.5371">UPDATE coupon</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140.5181" x="300.5" y="494.8477">SET state='REDEEMED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141.5781" x="299.97" y="510.1582">INC redemption_count</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="465.7993,555.5215,475.7993,559.5215,465.7993,563.5215,469.7993,559.5215" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="263.7188" x2="471.7993" y1="559.5215" y2="559.5215"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170.8408" x="285.3386" y="539.4688">INSERT redemption_history</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69.4941" x="336.012" y="554.7793">(audit trail)</text></g><g class="message" data-participant-1="API" data-participant-2="DB"><polygon fill="#181818" points="470.7993,584.832,480.7993,588.832,470.7993,592.832,474.7993,588.832" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="263.7188" x2="476.7993" y1="588.832" y2="588.832"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53.4536" x="346.5322" y="584.0898">COMMIT</text></g><g class="message" data-participant-1="API" data-participant-2="User"><polygon fill="#181818" points="49.1826,629.4531,39.1826,633.4531,49.1826,637.4531,45.1826,633.4531" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="43.1826" x2="252.7188" y1="633.4531" y2="633.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47.3599" x="122.2708" y="613.4004">200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181.3271" x="55.2871" y="628.7109">{success: true, history_id: ...}</text></g><path d="M14,653.4531 L14,754.4531 L506,754.4531 L506,663.4531 L496,653.4531 L14,653.4531" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M496,653.4531 L496,663.4531 L506,663.4531 L496,653.4531" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="164.1694" x="113.2261" y="671.0215">Key Points for Interview:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12.3335" x="113.2261" y="686.332">1.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="140.4165" x="129.6729" y="686.332">Permanent operation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60.9248" x="274.2026" y="686.332">(no undo)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12.3335" x="113.2261" y="701.6426">2.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="126.7881" x="129.6729" y="701.6426">Atomic transaction</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102.7813" x="260.5742" y="701.6426">(update + audit)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12.3335" x="113.2261" y="716.9531">3.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="176.5601" x="129.6729" y="716.9531">Multi-redemption support</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87.5596" x="310.3462" y="716.9531">(configurable)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12.3335" x="113.2261" y="732.2637">4.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="67.7803" x="129.6729" y="732.2637">Audit trail</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93.8247" x="201.5664" y="732.2637">for compliance</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202.4331" x="113.2261" y="747.5742">5. Either ALL succeed or ALL fail</text><!--SRC=[RLHTJzim57tthxXY3q16FmRifTA6qjHi4MrJjM5FbP2RN8f5OcUnKuOG_ttNJg6PHllGs3xtd7jkZciUfQf4BKhOYEnnM-j6vP4kT0sVhhdxClEECFYxGPNX38qHMmmBkLMGeR9OCsQbBH2Mc2EM4EccqWfwiC2w58eWa5HO2ojfz-Idt3xqfhZ3ufGnaLaIkpN4GIfMPh8I13yA5_4H20Fqot9XnKOOXAF9_iaVJSQCkKBeVNSm6C4YMQKmoBow6TI-cS5BfdDyNQkNXh1tCZ-34grmdAzENUw4HI_370bnJSP4DUO_uZcaot2-2gCqJkO7hDFjGbTyogCKMbdu31kj7scbxkLshOBWEbd2xM8IfZm86AEAtdk_qLl92gsLQclUYTlpNwAGr2YErghdPmJwIPczqfNRd6iB-AUIvDMlRrLEAEUyhFoq2rbAUqLpBkmRdTk-5hB0d05zkbQMoNGw3gERmm6TUE4HN0w7WylX1V2wrZN3Wjv7Xt0XZFc0i3M-xtYjLZm5OydHj-Cbdt0-uvFZjOhdKQVbEm8hwvd-euldAxvCk-07QIX0psjr8ffSMh0rEJlzk3fAPhCuzTivTb_dl-Y3vVFX498RYevfienIFoBw1izWBqfX6a6_ttzbg7BMeVHfKfgUz0xRT9-rEa5mWy-mq59P0_UK_DXTdvt4fn6b0-1Bdo27MwFVRaqGm8dIGBTJEtFd3XPQNShCELR6IRUefdA9eKpvUJZmXGFFciBANYSOfgagNLjNqcQrgSMcG5TmwTaFuoICQpNJPLL8GVy0XFdQ1oxj0xaBfrFmyy4STBkyfo8t4t0pO7y1]--></g></svg>