<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="1263px" preserveAspectRatio="none" style="width:1023px;height:1263px;background:#FEFEFE;" version="1.1" viewBox="0 0 1023 1263" width="1023px" zoomAndPan="magnify"><title>Redeem Coupon - With Advisory Lock Protection</title><defs/><g><rect fill="#FEFEFE" height="1263" style="stroke:none;stroke-width:1;" width="1023" x="0" y="0"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="352.1465" x="336.8049" y="28.5352">Redeem Coupon - With Advisory Lock Protection</text><g><title>API</title><rect fill="#FFFFFF" height="880.1582" style="stroke:#181818;stroke-width:1;" width="10" x="263.7188" y="165.5977"/></g><g><title>RedemptionService</title><rect fill="#FFFFFF" height="850.8477" style="stroke:#181818;stroke-width:1;" width="10" x="485.9795" y="194.9082"/></g><g><title>PostgreSQL</title><rect fill="#FFFFFF" height="452.5449" style="stroke:#181818;stroke-width:1;" width="10" x="764.0679" y="461.9688"/></g><rect fill="none" height="762.916" style="stroke:#000000;stroke-width:1.5;" width="1006.7563" x="10" y="275.8398"/><rect fill="none" height="392.6133" style="stroke:#000000;stroke-width:1.5;" width="986.7563" x="20" y="639.1426"/><g><title>User</title><rect fill="#000000" fill-opacity="0.00000" height="1063.9531" width="8" x="44.1826" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="48" x2="48" y1="118.9766" y2="1182.9297"/></g><g><title>API</title><rect fill="#000000" fill-opacity="0.00000" height="1063.9531" width="8" x="264.7188" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="268.0034" x2="268.0034" y1="118.9766" y2="1182.9297"/></g><g><title>RedemptionService</title><rect fill="#000000" fill-opacity="0.00000" height="1063.9531" width="8" x="486.9795" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="490.4551" x2="490.4551" y1="118.9766" y2="1182.9297"/></g><g><title>PostgreSQL</title><rect fill="#000000" fill-opacity="0.00000" height="1063.9531" width="8" x="765.0679" y="118.9766"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="768.6431" x2="768.6431" y1="118.9766" y2="1182.9297"/></g><g class="participant participant-head" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.3652" x="30" y="116.0234">User</text><ellipse cx="48.1826" cy="50.9883" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M48.1826,58.9883 L48.1826,85.9883 M35.1826,66.9883 L61.1826,66.9883 M48.1826,85.9883 L35.1826,100.9883 M48.1826,85.9883 L61.1826,100.9883" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="User"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30.3652" x="30" y="1195.4648">User</text><ellipse cx="48.1826" cy="1206.918" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M48.1826,1214.918 L48.1826,1241.918 M35.1826,1222.918 L61.1826,1222.918 M48.1826,1241.918 L35.1826,1256.918 M48.1826,1241.918 L61.1826,1256.918" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="API"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="35.4307" x="251.0034" y="87.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.4307" x="258.0034" y="108.0234">API</text></g><g class="participant participant-tail" data-participant="API"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="35.4307" x="251.0034" y="1181.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="21.4307" x="258.0034" y="1202.4648">API</text></g><g class="participant participant-head" data-participant="Service"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="143.0488" x="419.4551" y="87.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129.0488" x="426.4551" y="108.0234">RedemptionService</text></g><g class="participant participant-tail" data-participant="Service"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="143.0488" x="419.4551" y="1181.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129.0488" x="426.4551" y="1202.4648">RedemptionService</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76.8496" x="727.6431" y="116.0234">PostgreSQL</text><path d="M751.0679,66.4883 C751.0679,56.4883 769.0679,56.4883 769.0679,56.4883 C769.0679,56.4883 787.0679,56.4883 787.0679,66.4883 L787.0679,92.4883 C787.0679,102.4883 769.0679,102.4883 769.0679,102.4883 C769.0679,102.4883 751.0679,102.4883 751.0679,92.4883 L751.0679,66.4883" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M751.0679,66.4883 C751.0679,76.4883 769.0679,76.4883 769.0679,76.4883 C769.0679,76.4883 787.0679,76.4883 787.0679,66.4883" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76.8496" x="727.6431" y="1195.4648">PostgreSQL</text><path d="M751.0679,1208.418 C751.0679,1198.418 769.0679,1198.418 769.0679,1198.418 C769.0679,1198.418 787.0679,1198.418 787.0679,1208.418 L787.0679,1234.418 C787.0679,1244.418 769.0679,1244.418 769.0679,1244.418 C769.0679,1244.418 751.0679,1244.418 751.0679,1234.418 L751.0679,1208.418" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M751.0679,1208.418 C751.0679,1218.418 769.0679,1218.418 769.0679,1218.418 C769.0679,1218.418 787.0679,1218.418 787.0679,1208.418" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g><title>API</title><rect fill="#FFFFFF" height="880.1582" style="stroke:#181818;stroke-width:1;" width="10" x="263.7188" y="165.5977"/></g><g><title>RedemptionService</title><rect fill="#FFFFFF" height="850.8477" style="stroke:#181818;stroke-width:1;" width="10" x="485.9795" y="194.9082"/></g><g><title>PostgreSQL</title><rect fill="#FFFFFF" height="452.5449" style="stroke:#181818;stroke-width:1;" width="10" x="764.0679" y="461.9688"/></g><g class="message" data-participant-1="User" data-participant-2="API"><polygon fill="#181818" points="251.7188,161.5977,261.7188,165.5977,251.7188,169.5977,255.7188,165.5977" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="48.1826" x2="257.7188" y1="165.5977" y2="165.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196.5361" x="57.6826" y="145.5449">POST /coupons/redeem/{code}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121.2021" x="95.3496" y="160.8555">{user_id, metadata}</text></g><g class="message" data-participant-1="API" data-participant-2="Service"><polygon fill="#181818" points="473.9795,190.9082,483.9795,194.9082,473.9795,198.9082,477.9795,194.9082" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="273.7188" x2="479.9795" y1="194.9082" y2="194.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="193.2607" x="283.2188" y="190.166">redeem_coupon(code, user_id)</text></g><g class="message" data-participant-1="Service" data-participant-2="DB"><polygon fill="#181818" points="757.0679,238.5293,767.0679,242.5293,757.0679,246.5293,761.0679,242.5293" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="763.0679" y1="242.5293" y2="242.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="249.0884" x="507.9795" y="237.7871">pg_try_advisory_lock(hashtext(code))</text></g><path d="M774,207.9082 L774,262.9082 L946,262.9082 L946,217.9082 L936,207.9082 L774,207.9082" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M936,207.9082 L936,217.9082 L946,217.9082 L936,207.9082" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142.8604" x="780" y="225.4766">Advisory lock prevents</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151.9692" x="780" y="240.7871">concurrent redemptions</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87.5342" x="780" y="256.0977">on same code</text><path d="M10,275.8398 L72.1387,275.8398 L72.1387,283.1504 L62.1387,293.1504 L10,293.1504 L10,275.8398" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="762.916" style="stroke:#000000;stroke-width:1.5;" width="1006.7563" x="10" y="275.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17.1387" x="25" y="289.4082">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="126.0918" x="87.1387" y="288.4746">[Lock Acquired Failed]</text><g class="message" data-participant-1="DB" data-participant-2="Service"><polygon fill="#181818" points="506.9795,310.4609,496.9795,314.4609,506.9795,318.4609,502.9795,314.4609" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="500.9795" x2="768.0679" y1="314.4609" y2="314.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109.2686" x="577.8894" y="309.7188">FALSE (lock busy)</text></g><g class="message" data-participant-1="Service" data-participant-2="API"><polygon fill="#181818" points="284.7188,355.082,274.7188,359.082,284.7188,363.082,280.7188,359.082" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="278.7188" x2="484.9795" y1="359.082" y2="359.082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155.6572" x="302.0205" y="339.0293">CouponLockedException</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="157.3901" x="301.1541" y="354.3398">"Concurrent redemption"</text></g><g class="message" data-participant-1="API" data-participant-2="User"><polygon fill="#181818" points="59.1826,384.3926,49.1826,388.3926,59.1826,392.3926,55.1826,388.3926" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="53.1826" x2="262.7188" y1="388.3926" y2="388.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77.6382" x="117.1316" y="383.6504">409 Conflict</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="10" x2="1016.7563" y1="397.3926" y2="397.3926"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="136.5225" x="15" y="408.0273">[Lock Acquired Success]</text><g class="message" data-participant-1="DB" data-participant-2="Service"><polygon fill="#181818" points="506.9795,428.6582,496.9795,432.6582,506.9795,436.6582,502.9795,432.6582" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="500.9795" x2="768.0679" y1="432.6582" y2="432.6582"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129.7651" x="567.6411" y="427.916">TRUE (lock acquired)</text></g><g class="message" data-participant-1="Service" data-participant-2="DB"><polygon fill="#181818" points="752.0679,457.9688,762.0679,461.9688,752.0679,465.9688,756.0679,461.9688" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="758.0679" y1="461.9688" y2="461.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133.0278" x="563.5098" y="457.2266">BEGIN TRANSACTION</text></g><g class="message" data-participant-1="Service" data-participant-2="DB"><polygon fill="#181818" points="752.0679,502.5898,762.0679,506.5898,752.0679,510.5898,756.0679,506.5898" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="758.0679" y1="506.5898" y2="506.5898"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.6118" x="556.7178" y="486.5371">SELECT coupon + book</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="85.6235" x="587.2119" y="501.8477">FOR UPDATE</text></g><g class="message" data-participant-1="DB" data-participant-2="Service"><polygon fill="#181818" points="506.9795,531.9004,496.9795,535.9004,506.9795,539.9004,502.9795,535.9004" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="500.9795" x2="763.0679" y1="535.9004" y2="535.9004"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109.5352" x="575.2561" y="531.1582">Coupon + Config</text></g><g class="message" data-participant-1="Service" data-participant-2="Service"><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="537.9795" y1="611.1426" y2="611.1426"/><line style="stroke:#181818;stroke-width:1;" x1="537.9795" x2="537.9795" y1="611.1426" y2="624.1426"/><line style="stroke:#181818;stroke-width:1;" x1="496.9795" x2="537.9795" y1="624.1426" y2="624.1426"/><polygon fill="#181818" points="506.9795,620.1426,496.9795,624.1426,506.9795,628.1426,502.9795,624.1426" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="54.7739" x="560.6226" y="560.4688">Validate:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129.3271" x="523.3459" y="575.7793">- State = ASSIGNED?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.584" x="542.2175" y="591.0898">- Not expired?</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170.0601" x="502.9795" y="606.4004">- Under max redemptions?</text></g><path d="M20,639.1426 L82.1387,639.1426 L82.1387,646.4531 L72.1387,656.4531 L20,656.4531 L20,639.1426" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="392.6133" style="stroke:#000000;stroke-width:1.5;" width="986.7563" x="20" y="639.1426"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17.1387" x="35" y="652.7109">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="102.7974" x="97.1387" y="651.7773">[Validation Failed]</text><g class="message" data-participant-1="Service" data-participant-2="DB"><polygon fill="#181818" points="752.0679,673.7637,762.0679,677.7637,752.0679,681.7637,756.0679,677.7637" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="758.0679" y1="677.7637" y2="677.7637"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66.1108" x="596.9683" y="673.0215">ROLLBACK</text></g><g class="message" data-participant-1="Service" data-participant-2="DB"><polygon fill="#181818" points="752.0679,703.0742,762.0679,707.0742,752.0679,711.0742,756.0679,707.0742" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="758.0679" y1="707.0742" y2="707.0742"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162.519" x="548.7642" y="702.332">pg_advisory_unlock(code)</text></g><g class="message" data-participant-1="Service" data-participant-2="API"><polygon fill="#181818" points="284.7188,732.3848,274.7188,736.3848,284.7188,740.3848,280.7188,736.3848" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="278.7188" x2="484.9795" y1="736.3848" y2="736.3848"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125.0044" x="317.3469" y="731.6426">ValidationException</text></g><g class="message" data-participant-1="API" data-participant-2="User"><polygon fill="#181818" points="59.1826,761.6953,49.1826,765.6953,59.1826,769.6953,55.1826,765.6953" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="53.1826" x2="262.7188" y1="765.6953" y2="765.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91.2412" x="110.3301" y="760.9531">400/403 Error</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="20" x2="1006.7563" y1="774.6953" y2="774.6953"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="108.5122" x="25" y="785.3301">[Validation Passed]</text><g class="message" data-participant-1="Service" data-participant-2="DB"><polygon fill="#181818" points="752.0679,836.582,762.0679,840.582,752.0679,844.582,756.0679,840.582" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="758.0679" y1="840.582" y2="840.582"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101.2261" x="579.4106" y="805.2188">UPDATE coupon</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140.5181" x="559.7646" y="820.5293">SET state='REDEEMED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141.5781" x="559.2346" y="835.8398">INC redemption_count</text></g><g class="message" data-participant-1="Service" data-participant-2="DB"><polygon fill="#181818" points="752.0679,881.2031,762.0679,885.2031,752.0679,889.2031,756.0679,885.2031" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="758.0679" y1="885.2031" y2="885.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170.8408" x="544.6033" y="865.1504">INSERT redemption_history</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69.4941" x="595.2766" y="880.4609">(audit trail)</text></g><g class="message" data-participant-1="Service" data-participant-2="DB"><polygon fill="#181818" points="757.0679,910.5137,767.0679,914.5137,757.0679,918.5137,761.0679,914.5137" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="763.0679" y1="914.5137" y2="914.5137"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53.4536" x="605.7969" y="909.7715">COMMIT</text></g><g class="message" data-participant-1="Service" data-participant-2="DB"><polygon fill="#181818" points="757.0679,942.8242,767.0679,946.8242,757.0679,950.8242,761.0679,946.8242" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="495.9795" x2="763.0679" y1="946.8242" y2="946.8242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="240.9063" x="512.0706" y="942.082">pg_advisory_unlock(hashtext(code))</text></g><path d="M774,927.5137 L774,952.5137 L991,952.5137 L991,937.5137 L981,927.5137 L774,927.5137" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M981,927.5137 L981,937.5137 L991,937.5137 L981,927.5137" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196.6885" x="780" y="945.082">Always released in finally block</text><g class="message" data-participant-1="Service" data-participant-2="API"><polygon fill="#181818" points="284.7188,975.1348,274.7188,979.1348,284.7188,983.1348,280.7188,979.1348" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="278.7188" x2="484.9795" y1="979.1348" y2="979.1348"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112.7407" x="323.4788" y="974.3926">Coupon + History</text></g><g class="message" data-participant-1="API" data-participant-2="User"><polygon fill="#181818" points="59.1826,1019.7559,49.1826,1023.7559,59.1826,1027.7559,55.1826,1023.7559" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="53.1826" x2="262.7188" y1="1023.7559" y2="1023.7559"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47.3599" x="132.2708" y="1003.7031">200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111.249" x="100.3262" y="1019.0137">{success: true, ...}</text></g><path d="M20,1050.7559 L20,1167.7559 L795,1167.7559 L795,1060.7559 L785,1050.7559 L20,1050.7559" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M785,1050.7559 L785,1060.7559 L795,1060.7559 L785,1050.7559" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="188.2334" x="233.9385" y="1068.3242">Key Implementation Details:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12.3335" x="233.9385" y="1083.6348">1.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="91.2285" x="250.3853" y="1083.6348">Advisory lock</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154.8511" x="345.7271" y="1083.6348">prevents race conditions</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12.3335" x="233.9385" y="1098.9453">2.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="60.4487" x="250.3853" y="1098.9453">Row lock</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257.6069" x="314.9473" y="1098.9453">(FOR UPDATE) ensures transaction safety</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="12.3335" x="233.9385" y="1114.2559">3.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="141.4448" x="250.3853" y="1114.2559">Two-level protection</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102.9082" x="395.9434" y="1114.2559">(advisory + row)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89.4321" x="233.9385" y="1129.5664">4. Works from</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="66.5361" x="327.4839" y="1129.5664">ASSIGNED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172.231" x="398.1333" y="1129.5664">state (no LOCKED required)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="45.6206" x="233.9385" y="1144.877">5. Lock</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="106.5391" x="283.6724" y="1144.877">always released</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="84.8428" x="394.3247" y="1144.877">(finally block)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223.2217" x="233.9385" y="1160.1875">6. Atomic operation (all or nothing)</text><!--SRC=[XLLHR-8u47xFhnYn3mkvGhdTtac7jBTAGxg7Ie4bzFO52Hd71Ol4Pcs75gtwts_iX0HQsXCFXNhccs_c6t_M6owsH94CbeHkLahc8WbbAXLyk8dinzDLX6O_SoOeksDQanKBKhuIG9amJ7cUuIPbC6K9Onc4CjzA0MtumSqQWcJ7jLHx64gwWOcIXb73fV0yGWrMkjS8W2KCftnBX856C1aqW6Z0lwS75Z_RskIOgHsdp8MLtxs46B8aca5Z8hLPAHP_7xg0_hNdsIhG_jjYGWycutW6bzJnr9VAqRxyHMN2dkVYLuwn2vvSGCOCiQZFbYhV4SCS9y-285PP6F4AX4K1sBGu5r2YjEhS0r7la8WO_MjCz_tjQc7KVa7AMIrId5LpJVJQi2VZ05ijt_S43WyKNwsD1_LWRJ1i5TkX61eFg1GqLmf_EMB5nEm1Yg99ni3YUKmaOF5GXzGKuWJqPyun1Mu8Jrc26M09jazwlGc6SGHDLtIPwttBXLKjLJCkji3YiYHweionc8j6U8vTmu6ukIA04wi7Lzs_44Kyf9mQZwMex2dBEASKb_4ypTdq_i2Ib0a5qrEwfGBNqRV127E2KHo4iy5uvA8gvN23taoDes4Kpg3G7dw3fPIRkV3zc_4KxYVzO1QXS6SfXeSKsoHVdIrHH_zBKexBo7fpqOROM5fV88ZZmRTHrFzg_pcI1jZJrhRgVj-B1EUOaQVZDVXQbx6wbwXuSYpwkJwdu-7mEWXltmp07QxsDnTkWztYlaweTgIkNcr85Vrg6RgNLztF42abbGjo6t74VqAqVeT_eKMfqrp4qGoqdUANZzEe7qLtKV_ZN0n6uT6mx8KMfa9y4temYgFfx3XnpJLwstukcYHFk06ZSBYj_qSAntTtWrbrdB2NA_XkjlEHbngyTf53UkqcFGZIHxBNs4BAq48Ju08Uk21fkeUbXNcd-8iRZ_lyJz7zMr9-wdPXV8j6guiBtCFnvEYOdKxdkL1M9DQUFE-e_yhbsQaNkoRaZXKFoKKn9z-_PNiOPDkKPMWqnNxqqSrvgdjk0hztCEZ4GNs_yb1GX5gN52XTQPsVRFnKFXv2c_NrRY5VdIkchSf24_UweT4-C6D7yDbcpXvbEqNm56iS7a2BSX0BXwRaersGgmxya6gZuK79p78iRpX6ktM5ff0m78UtKH_LgetjZqxXZhvFJgMqPKwajD5_TY0mCkCKv9QfOZvD305ya76YQovMhVg5-0y0]--></g></svg>