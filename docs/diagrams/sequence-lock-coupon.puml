@startuml Lock Coupon
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

title Lock Coupon - Optional Demo/Testing Feature

actor User
participant "API" as API
participant "RedemptionService" as Service
database "PostgreSQL" as DB

User -> API : POST /coupons/lock/{code}\n{user_id}
activate API

API -> Service : lock_coupon(code, user_id)
activate Service

Service -> DB : SELECT coupon\nWHERE code = ?

DB --> Service : Coupon

Service -> Service : Validate:\n- Valid state transition?\n- Not already locked?

alt Validation Failed
    Service --> API : ValidationException
    API --> User : 400/403 Error
else Validation Passed
    Service -> DB : **pg_try_advisory_lock(hashtext(code))**
    
    alt Advisory Lock Failed
        DB --> Service : FALSE (concurrent access)
        Service --> API : CouponLockedException
        API --> User : 409 Conflict
    else Advisory Lock Acquired
        DB --> Service : TRUE
        
        Service -> DB : BEGIN TRANSACTION
        activate DB
        
        Service -> DB : UPDATE coupon\nSET state='LOCKED'\nSET locked_until=NOW()+5min
        
        Service -> DB : COMMIT
        deactivate DB
        
        Service --> API : Locked Coupon
        API --> User : 200 OK\n{state: "LOCKED", expires_at: ...}
    end
end

deactivate Service
deactivate API

note over User, DB
  **Important Notes:**
  1. Lock is **OPTIONAL** - for demo/testing only
  2. Redemption works **without** lock (from ASSIGNED)
  3. Advisory lock prevents concurrent lock attempts
  4. 5-minute timeout prevents deadlocks
  5. Can be unlocked manually or expires automatically
  6. **Cannot redeem** while in LOCKED state (must unlock first)
end note

@enduml
